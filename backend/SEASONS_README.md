# Система сезонов CyberCard

## Описание

Система сезонов позволяет разделять карточки по временным периодам. Каждый сезон имеет свои уникальные карточки, которые нельзя использовать в других сезонах.

## Основные концепции

### 1. Коллекция
- Содержит только **уникальные** карточки (не стакаются)
- Максимум 1 экземпляр каждой карточки
- Привязана к текущему сезону

### 2. Хранилище
- Может содержать **дубликаты** карточек
- Максимум 100 карточек
- Карточки не стакаются (каждая хранится отдельно)
- Привязано к текущему сезону

### 3. Сезоны
- Каждый сезон имеет уникальный номер
- Только один сезон может быть активным
- При смене сезона карточки архивируются
- Архивные карточки можно просматривать, но не использовать

### 4. История сезонов
- Хранит карточки из прошлых сезонов
- Доступна для просмотра через селектор сезонов
- Карточки из архива нельзя использовать в текущем сезоне

## Инициализация

### Шаг 1: Запустите скрипт инициализации

```bash
cd backend
node scripts/initSeason.js
```

Этот скрипт:
- Создаст первый сезон
- Установит всем существующим карточкам `season: 1`
- Активирует первый сезон

### Шаг 2: Проверьте результат

```bash
# Проверьте, что сезон создан
curl http://localhost:5001/api/seasons/active
```

## API Endpoints

### Получить все сезоны
```
GET /api/seasons
```

### Получить активный сезон
```
GET /api/seasons/active
```

### Получить историю сезонов пользователя
```
GET /api/seasons/history
Headers: Authorization: Bearer <token>
```

### Создать новый сезон (только админ)
```
POST /api/seasons
Headers: Authorization: Bearer <token>
Body: {
  "name": "Второй сезон",
  "startDate": "2025-01-01",
  "endDate": "2025-12-31",
  "description": "Описание сезона"
}
```

### Активировать сезон (только админ)
```
PUT /api/seasons/:seasonId/activate
Headers: Authorization: Bearer <token>
```

**ВАЖНО:** При активации нового сезона:
1. Все предыдущие сезоны деактивируются
2. Карточки всех пользователей архивируются в `seasonHistory`
3. Текущие коллекции и хранилища очищаются
4. Пользователи начинают с чистого листа в новом сезоне

## Создание карточек для нового сезона

При создании новых карточек для сезона, обязательно указывайте номер сезона:

```javascript
const newPlayer = new Player({
  nickname: "s1mple",
  ovr: 99,
  game: "cs",
  season: 2, // Номер сезона
  // ... другие поля
});
```

## Фронтенд

### Компонент SeasonSelector

Компонент `SeasonSelector` позволяет пользователям:
- Просматривать все доступные сезоны
- Переключаться между текущим и архивными сезонами
- Видеть предупреждение при просмотре архивных сезонов

### Использование

```jsx
import SeasonSelector from '../components/profile/SeasonSelector';

<SeasonSelector 
  currentSeason={currentSeason} 
  onSeasonChange={handleSeasonChange}
/>
```

## Миграция существующих данных

Если у вас уже есть карточки в базе данных:

1. Запустите скрипт инициализации (см. выше)
2. Все существующие карточки получат `season: 1`
3. Все пользователи будут в сезоне 1

## Пример: Переход на новый сезон

```javascript
// 1. Создайте новый сезон (через API или админ-панель)
POST /api/seasons
{
  "name": "Сезон 2: Новая эра",
  "startDate": "2025-01-01",
  "endDate": "2025-12-31"
}

// 2. Создайте карточки для нового сезона
// Убедитесь, что у всех новых карточек season: 2

// 3. Активируйте новый сезон
PUT /api/seasons/<seasonId>/activate

// Результат:
// - Все карточки пользователей из сезона 1 архивированы
// - Пользователи начинают с пустой коллекцией в сезоне 2
// - Старые карточки доступны для просмотра через селектор сезонов
```

## Troubleshooting

### Ошибка: "User validation failed: nickname is required"

Эта ошибка исправлена. Убедитесь, что используете `{ validateBeforeSave: false }` при сохранении пользователя:

```javascript
await user.save({ validateBeforeSave: false });
```

### Карточки не фильтруются по сезонам

Проверьте, что:
1. У всех карточек установлено поле `season`
2. При запросе карточек используется фильтр по сезону
3. Активный сезон корректно определяется

### Архивные карточки не отображаются

Убедитесь, что:
1. `seasonHistory` правильно заполнена при смене сезона
2. Используется populate для загрузки карточек из истории
3. Селектор сезонов корректно передает номер сезона
